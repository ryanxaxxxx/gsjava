<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa da Rota - GreenWay</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; width: 100%; }

    #btnLocalizacao, #btnCadastro, #btnLogout {
      position: absolute;
      left: 20px;
      z-index: 9999;
      padding: 10px 16px;
      background: white;
      border-radius: 10px;
      border: 1px solid #ccc;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
	
    #btnLocalizacao:hover,
    #btnCadastro:hover {
      background: #f0f0f0;
    }

    #btnLogout {
      background: linear-gradient(135deg, #2d8659 0%, #1e5d3f 100%);
      color: white;
      border: none;
    }

    #btnLogout:hover {
      background: linear-gradient(135deg, #1e5d3f 0%, #2d8659 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(45, 134, 89, 0.4);
    }

    /* DistÃ¢ncia entre os botÃµes */
    #btnLocalizacao { top: 20px; }
    #btnCadastro { top: 70px; }
    #btnLogout { top: 120px; }
  </style>
</head>
<body>
  <script>
    // Verificar autenticaÃ§Ã£o antes de carregar o mapa
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/login.html';
    }
  </script>

  <!-- BotÃ£o de localizaÃ§Ã£o -->
  <button id="btnLocalizacao">&#x1F4CD; Usar minha localizaÃ§Ã£o</button>

  <!-- BotÃ£o de cadastro de endereÃ§o -->
  <button id="btnCadastro" onclick="window.location.href='/cadastro-endereco.html'">
    âž• Cadastrar novo destino
  </button>

  <!-- BotÃ£o de logout -->
  <button id="btnLogout" onclick="logout()">
    ðŸšª Sair
  </button>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // Inicializa mapa em SÃ£o Paulo
    const map = L.map('map').setView([-23.5505, -46.6333], 10);

    // Base OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // PONTOS (origem e destino)
    const origem = [-23.5505, -46.6333];   // SP
    const destino = [-22.9056, -47.0608];  // Campinas

    // Marcadores
    L.marker(origem).addTo(map).bindPopup("Origem");
    L.marker(destino).addTo(map).bindPopup("Destino");

    // ============================
    // ðŸ›£ï¸ TRAÃ‡AR ROTA REAL (OSRM)
    // ============================
    fetch(`https://router.project-osrm.org/route/v1/driving/${origem[1]},${origem[0]};${destino[1]},${destino[0]}?overview=full&geometries=geojson`)
      .then(res => res.json())
      .then(data => {
        const rota = data.routes[0].geometry;

        L.geoJSON(rota, {
          style: {
            color: "blue",
            weight: 5
          }
        }).addTo(map);

        const coords = rota.coordinates.map(c => [c[1], c[0]]);
        map.fitBounds(coords);
      });

    // ============================
    // ðŸ“ BOTÃƒO DE LOCALIZAÃ‡ÃƒO
    // ============================
    document.getElementById("btnLocalizacao").addEventListener("click", () => {

      if (!navigator.geolocation) {
        alert("GeolocalizaÃ§Ã£o nÃ£o Ã© suportada neste navegador.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;

          map.setView([lat, lon], 15);

          L.marker([lat, lon]).addTo(map)
            .bindPopup('\u{1F4CD} VocÃª estÃ¡ aqui')
            .openPopup();
        },
        () => {
          alert("NÃ£o foi possÃ­vel obter sua localizaÃ§Ã£o.");
        }
      );

    });

    // ============================
    // ðŸšª FUNÃ‡ÃƒO DE LOGOUT
    // ============================
    function logout() {
      if (confirm('Deseja realmente sair?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('userEmail');
        window.location.href = '/login.html';
      }
    }
  </script>
</body>
</html>
